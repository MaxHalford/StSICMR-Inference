<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>StSICMR-Inference by MaxHalford</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>StSICMR-Inference</h1>
        <h2></h2>
        <a href="https://github.com/MaxHalford/StSICMR-Inference" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h2>
<a id="symmetrical-island-model-with-changes-in-migration-rates---inference" class="anchor" href="#symmetrical-island-model-with-changes-in-migration-rates---inference" aria-hidden="true"><span class="octicon octicon-link"></span></a>Symmetrical Island Model with Changes in Migration Rates - Inference</h2>

<p>The Symmetrical Island Model with Changes in Migration Rates (StSICMR) is a model developped by <a href="http://fr.viadeo.com/fr/profile/olivier.mazet1">Oliver Mazet</a> and <a href="https://www.wikiwand.com/en/Loun%C3%A8s_Chikhi">Lounès Chikhi</a> with their research team.</p>

<p>This repository supposes that you are familiar with the <a href="http://www.nature.com/nature/journal/v475/n7357/full/nature10231.html">PSMC algorithm</a> developped by <a href="https://www.wikiwand.com/en/Richard_M._Durbin">Richard Durbin</a> and <a href="https://www.wikiwand.com/en/Heng_Li">Heng Li</a>.</p>

<p>The method tries to fit the model to a PSMC timeline produced with <a href="https://github.com/lh3/psmc">Heng Li's algorithm</a>. It starts by extracting the times and the lambda values of the last iteration from a <code>.psmc</code> file. Then it normalizes the lambda value so that they start at 1 (because the model is normalized to begin at 1 also). For the fitting part it uses a <a href="http://www.wikiwand.com/en/Genetic_algorithm">genetic algorithm</a> using <a href="https://www.wikiwand.com/en/Tournament_selection">tournament selection</a>. The implementation is done in Python 3.4 and is designed to be comprehensible and easy to edit. I wrote a <a href="http://maxhalford.com/resources/notebooks/genetic-algorithms.html">tutorial on genetic algorithms</a> to explain how I code genetic algorithms with Python.</p>

<h2>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h2>

<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#output">Output</a></li>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#contact">Contact</a></li>
<li><a href="#license">License</a></li>
<li><a href="#issues">Issues</a></li>
<li><a href="#updates">Updates</a></li>
</ul>

<h2>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h2>

<p>All of the code has been tested with both Python 2 and Python 3. People have successfully used it on Ubuntu, Mac OS and Windows. You can either use your current Python installation, a virtual environment or the <a href="https://store.continuum.io/cshop/anaconda/">Anaconda distribution</a>.</p>

<h3>
<a id="1-normal" class="anchor" href="#1-normal" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Normal</h3>

<p>The following module versions were used, that said older and newer versions have a good chance of working too.</p>

<pre><code>- matplotlib == 1.4.3
- pandas == 0.16.2
- Cython == 0.22.1
- numpy == 1.9.2
</code></pre>

<p>If you do not have them installed type</p>

<div class="highlight highlight-sh"><pre><span class="pl-c1">cd</span> StSICMR-Inference
pip3 install -r requirements.txt</pre></div>

<p>If you don't have <code>pip</code> installed then you can install the modules manually, this should be easy on any platform as all of them are extremely popular modules.</p>

<h3>
<a id="2-with-a-virtual-environment" class="anchor" href="#2-with-a-virtual-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. With a virtual environment</h3>

<p>If you want to be safe and not mess with your Python environment you use a <a href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">virtual environment</a> included in the repository.</p>

<div class="highlight highlight-sh"><pre>pip3 install virtualenv
virtualenv venv
<span class="pl-c1">source</span> venv/bin/activate
pip install -r requirements.txt</pre></div>

<p>This uses a sandboxed Python where you can do as you please without fear of screwing up your setup. To deactivate the virtual environment type <code>deactivate</code>. To activate it type <code>source venv/bin/activate</code>, or else the default Python interpreter will be used. You can delete the <code>StSICMR-Inference</code> folder and it will be as if nothing ever happened.</p>

<h3>
<a id="3-anaconda" class="anchor" href="#3-anaconda" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Anaconda</h3>

<p>This is probably the easiest way if you don't have Python installed. Simply <a href="http://continuum.io/downloads">download Anaconda</a> for your platform (you can choose between Python 2 or 3). Anaconda includes all the modules necessary so there is nothing else to do.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a id="convert" class="anchor" href="#convert" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convert</h3>

<p>The algorithm requires a CSV file. Most of the time these are to be extracted from PSMC files. The <code>convert.py</code>script can do this, as can be seen in the <a href="#examples">Examples</a> section. You can use any CSV file, the first column will be considered as the time vector and the second one as the PSMC vector.</p>

<h3>
<a id="infer" class="anchor" href="#infer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Infer</h3>

<p>The main script is called <code>infer.py</code> and guesses the parameters for a given PSMC timeline.</p>

<table>
<thead>
<tr>
<th>Argument</th>
<th>Name</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>-v</td>
<td>Version</td>
<td>Get the version of the script.</td>
<td></td>
</tr>
<tr>
<td>-n</td>
<td>Islands</td>
<td>Maximal number of islands for the first generation.</td>
<td>100</td>
</tr>
<tr>
<td>-s</td>
<td>Switches</td>
<td>Number of switches for the model.</td>
<td>0</td>
</tr>
<tr>
<td>-c</td>
<td>Size</td>
<td>Allow the islands to change size.</td>
<td>False</td>
</tr>
<tr>
<td>-r</td>
<td>Repetitions</td>
<td>Number of times to repeat the process.</td>
<td>1</td>
</tr>
<tr>
<td>-g</td>
<td>Generations</td>
<td>Number of iterations for each population.</td>
<td>100</td>
</tr>
<tr>
<td>-m</td>
<td>Method</td>
<td>Method for evaluating the fits.</td>
<td>'integral'</td>
</tr>
<tr>
<td>-k</td>
<td>Keep</td>
<td>Set to True to save the inference as a plot and a JSON file.</td>
<td>'False'</td>
</tr>
<tr>
<td>-o</td>
<td>Outfile</td>
<td>Override name of output files.</td>
<td></td>
</tr>
</tbody>
</table>

<p>The initial number of islands (<code>-n</code>) is not important as the algorithm usually finds the right number of islands straight away. The higher the initial population size (<code>-p</code>) is the more of the search space will be covered at first. If you don't want to allow the islands to change sizes then don't include the initial maximal island size argument (<code>-c</code>), if you want to set it to <code>True</code>. For repeating the process you can use the repetitions arguments (<code>-r</code>) and the best model will be saved. The genetic algorithm implementation stops after a fixed number of generations (<code>-g</code>). The mutation rate (<code>-u</code>) is important; if it is high the algorithm will not get stuck, at the cost of precision. There are two methods (<code>-m</code>) for measuring the distance between two curves:</p>

<ul>
<li>the least squares on the vectors which doesn't take into account the abscissa (<code>'least_squares'</code>).</li>
<li>the least squares on the functions which does take into account the abscissa (<code>'integral'</code>).</li>
</ul>

<p>If the keep argument (<code>-k</code>) is set to <code>True</code> then the best model will be saved as a PNG file for the chart and a JSON file for the parameters with default names. You can also use the outfile argument (<code>-o</code>) for overriding the name given to the saved files.</p>

<p>At every repetition the console will prompt you if you desire to continue (<code>y</code>) or to go to the next repetition (<code>n</code>). If you do then it will ask you for how many generations you wish to continue.</p>

<h3>
<a id="manual" class="anchor" href="#manual" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manual</h3>

<p>The other script called <code>manual.py</code> is for visualizing a model with user-defined parameters.</p>

<table>
<thead>
<tr>
<th>Argument</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>-l</td>
<td>Normalization</td>
</tr>
<tr>
<td>-n</td>
<td>Islands</td>
</tr>
<tr>
<td>-T</td>
<td>Switch times</td>
</tr>
<tr>
<td>-M</td>
<td>Migration rates</td>
</tr>
<tr>
<td>-C</td>
<td>Population sizes</td>
</tr>
<tr>
<td>-k</td>
<td>Keep</td>
</tr>
<tr>
<td>-o</td>
<td>Override</td>
</tr>
</tbody>
</table>

<h3>
<a id="taming-the-genetic-algorithm" class="anchor" href="#taming-the-genetic-algorithm" aria-hidden="true"><span class="octicon octicon-link"></span></a>Taming the genetic algorithm</h3>

<ul>
<li>Increasing the generation size can have an impact, the longer the algorithm runs the lower the chance that the algorithm won't improve the model.</li>
<li>If the algorithm seems to fail you can try to increase the mutation rate. Often is the case this will enable it to find a better area. However a high mutation rate removes precision from the algorithm.</li>
<li>
<em>Trying again</em> isn't a bad idea when using genetic algorithms.</li>
<li>The initial population size can be important, the higher it is and the more of the search space will be explored at first</li>
<li>The genetic algorithm uses <a href="https://www.wikiwand.com/en/Tournament_selection">tournament selection</a> for choosing which individuals will breed new individuals. You can configure the parameters of the tournament and the mutation amplitudes applied to the parameters in the <code>lib/inference/genalgOptions.json</code> file:

<ul>
<li>
<code>"rounds"</code> is the number of individuals that will breed new individuals.</li>
<li>
<code>"roundSize"</code> is the size of each tournament.</li>
<li>
<code>"offspring"</code> is the quantity of individuals the chosen individuals will breed.
There are offspring x rounds number of new individuals. The way the tournament works is that the best out of a random       sample of individuals is chosen. This means that big tournaments are favorable to strong individuals and small          tournaments allow weaker individuals to go through (which isn't necessarily a bad thing,                    <a href="http://www.wikiwand.com/en/Simulated_annealing">simulated annealing</a> does the same thing).</li>
</ul>
</li>
<li>It also has to be said that including the island size parameter (<code>-c</code>) requires the algorithm to run for much more generations because the search space becomes much bigger.</li>
<li>If you think you have a better way of measuring the distance between two curves you can add it to the <code>distance.py</code> script and modify the <code>evaluate()</code> procedure in the <code>genalg.py</code> script.</li>
<li>A recurring problem was that sometimes the times as which the migration rates changes were so close it was like having only one. The <code>genalgOptions.json</code> now has a <code>timeGapPercentage</code> parameter. This obliges times to be split by at least a percetenge of the last time. For example if the last time is 120 and the parameter is set to 18 then times will have to be spread out by at least 120 * 18 / 100 = 21.6.</li>
</ul>

<h2>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h2>

<p>The following commands use PSMC files provided by <a href="https://github.com/willyrv">Willy Rodriguez</a>.</p>

<h3>
<a id="first-example---0-switches" class="anchor" href="#first-example---0-switches" aria-hidden="true"><span class="octicon octicon-link"></span></a>First example - 0 switches</h3>

<div class="highlight highlight-sh"><pre>python convert.py data/example1.psmc
python infer.py data/example1.csv -s 0 -g 25 -r 1 -m least_squares -k True</pre></div>

<p><img src="http://i.imgur.com/dAjLVEo.png" alt="First example"></p>

<h3>
<a id="second-example---3-switches" class="anchor" href="#second-example---3-switches" aria-hidden="true"><span class="octicon octicon-link"></span></a>Second example - 3 switches</h3>

<div class="highlight highlight-sh"><pre>python convert.py data/example2.psmc
python infer.py data/example2.csv -s 3 -g 100 -m integral -k True -o data/example2_3_switch</pre></div>

<p><img src="http://i.imgur.com/kxyBi7l.png" alt="Second example"></p>

<h3>
<a id="third-example---islands-can-change-size" class="anchor" href="#third-example---islands-can-change-size" aria-hidden="true"><span class="octicon octicon-link"></span></a>Third example - Islands can change size</h3>

<p>You can also try to fit the model to the PSMC curve yourself. Make sure to give the same number of times (T) and migration rates (M). Don't forget that the first time is always <code>0</code>.</p>

<div class="highlight highlight-sh"><pre>python convert.py data/example3.psmc
python infer.py data/example3.csv -s 3 -c True -g 100 -m least_squares -k True -o data/example3_island_size_change</pre></div>

<p><img src="http://i.imgur.com/6H4m7IL.png" alt="Third example"></p>

<h3>
<a id="fourth-example---manual" class="anchor" href="#fourth-example---manual" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fourth example - Manual</h3>

<p>You can also try to fit the model to the PSMC curve yourself. Make sure to give the same number of times (T) and migration rates (M). Don't forget that the first time is always <code>0</code>.</p>

<div class="highlight highlight-sh"><pre>python convert.py data/example4.psmc
python manual.py data/example4.csv -n 12 -T 0 3 8 20 -M 3 4 3 7 -C 1 1 1 1 -k True</pre></div>

<p><img src="http://i.imgur.com/O7kLV5J.png" alt="Fourth example"></p>

<h2>
<a id="output" class="anchor" href="#output" aria-hidden="true"><span class="octicon octicon-link"></span></a>Output</h2>

<p>Changing the chart outputs is really easy. The <code>lib/chartOptions.json</code>file is made for easily doing so. The default settings produce the charts you see in the <a href="#examples">Examples</a> section. Most of the parameters are not too hard to understand. I would recommend reading the documentation from <a href="http://matplotlib.org/contents.html">matplotlib</a> if you want to do something complicated.</p>

<h2>
<a id="architecture" class="anchor" href="#architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>Architecture</h2>

<pre><code>StSICMR-Inference
├───┐ data
│   └─── ...
├───┐ lib
│   ├───┐ inference
│   │   ├─── __init__.py
│   │   ├─── distance.py
│   │   ├─── genalg.py
│   │   └─── genalgOptions.json
│   ├─── __init__.py
│   ├─── chartOptions.json
│   ├─── model.py
│   ├─── plotting.py
│   └─── tools.py
├─── convert.py
├─── infer.py
├─── LICENSE
├─── manual.py
├─── README.md
├─── requirements.txt
└─── utests.py
</code></pre>

<p>The two main scripts (<code>infer.py</code> and <code>manual.py</code>) are in the top-level of the directory. In the <code>lib</code> folder is where the heavy-lifting is being done:</p>

<ul>
<li>
<code>model.py</code> contains the StSCMIR class where the mathematics are done. </li>
<li>
<code>tools.py</code> is for opening and parsing a <code>.psmc</code> file.</li>
<li>
<code>genalg.py</code> tries to find good parameters for the model to fit a PSMC timeline.</li>
<li>
<code>plotting.py</code> plots a model and a PSMC timeline on the same chart.</li>
</ul>

<p>The reason why <code>lib</code> contains the <code>ìnference</code> folder is if ever there will be another method of infering the parameters, it doesn't necessarily have to be a genetic algorithm. However the distance measures between the target curve and the model curve will always be the same, hence the <code>distance.py</code> script that can easily be reused with other methods.</p>

<h2>
<a id="contact" class="anchor" href="#contact" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contact</h2>

<p>If you have questions about the mathematics please send a mail to <a href="mailto:willyrv@gmail.com">willyrv@gmail.com</a>.</p>

<p>If you have questions about the genetic algorithm and/or the code please send a mail to <a href="mailto:maxhalford25@gmail.com">maxhalford25@gmail.com</a>.</p>

<p>I wrote an <a href="http://maxhalford.com/resources/internships/L3_Internship_Max_Halford.pdf">internship report</a> related to this software in 2015 for my third year at university.</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>See the <a href="LICENSE">LICENSE file</a>.</p>

<h2>
<a id="issues" class="anchor" href="#issues" aria-hidden="true"><span class="octicon octicon-link"></span></a>Issues</h2>

<p>Please click on the "Issues" button or use the email adresses, we'll be glad to help.</p>

<h2>
<a id="updates" class="anchor" href="#updates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updates</h2>

<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Update</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>June 2015</td>
<td>Initialization.</td>
</tr>
<tr>
<td>1.1</td>
<td>July 2015</td>
<td>Added the possibility to allow the islands to change size when the migration rates change.</td>
</tr>
<tr>
<td>1.2</td>
<td>September 2015</td>
<td>Enforce the switch times to be separated by a minimal margin.</td>
</tr>
</tbody>
</table>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/MaxHalford/StSICMR-Inference/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/MaxHalford/StSICMR-Inference/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/MaxHalford/StSICMR-Inference"></a> is maintained by <a href="https://github.com/MaxHalford">MaxHalford</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
